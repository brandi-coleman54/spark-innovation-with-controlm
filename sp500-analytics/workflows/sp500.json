{
  "zzz-SP500-MFT-to-Table-Setup" : {
    "Type" : "Folder",
    "ControlmServer" : "IN01",
    "RunAs" : "controlm",
    "SubApplication" : "zzz_SAP500",
    "Application" : "zzz_SAP500",
    "BQ Clean Data" : {
      "Type" : "Job:GCP BigQuery",
      "ConnectionProfile" : "MOL-BQ-CP",
      "Action" : "Query",
      "Run Select Query and Copy to Table" : "unchecked",
      "Query Type" : "SQL Query",
      "Copy Operation Type" : "Copy",
      "Show Load Options" : "unchecked",
      "Project Name" : "sso-gcp-dba-ctm4-pub-cc10274",
      "Dataset Name" : "sp500_dataset",
      "SQL Statement" : "CREATE OR REPLACE TABLE `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.sp500_clean` AS%4ESELECT%4E  DATE(date) AS date,%4E  open,%4E  high,%4E  low,%4E  close,%4E  volume,%4E  Name,%4E  SAFE_DIVIDE(close - open, open) AS daily_return,%4E  AVG(close) OVER (PARTITION BY Name ORDER BY DATE(date) ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS ma_7,%4E  AVG(close) OVER (PARTITION BY Name ORDER BY DATE(date) ROWS BETWEEN 29 PRECEDING AND CURRENT ROW) AS ma_30,%4E  STDDEV(close) OVER (PARTITION BY Name ORDER BY DATE(date) ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS volatility_7d%4EFROM%4E  `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.sp500_raw`;%4E",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "RunAs" : "MOL-BQ-CP",
      "Application" : "zzz_SAP500",
      "Variables" : [ {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      }, {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      } ],
      "eventsToWaitFor" : {
        "Type" : "WaitForEvents",
        "Events" : [ {
          "Event" : "BQ_Load_data_to_table-TO-BQ_Clean_Data"
        } ]
      },
      "eventsToDelete" : {
        "Type" : "DeleteEvents",
        "Events" : [ {
          "Event" : "BQ_Load_data_to_table-TO-BQ_Clean_Data"
        } ]
      }
    },
    "BQ Load data to table" : {
      "Type" : "Job:GCP BigQuery",
      "ConnectionProfile" : "MOL-BQ-CP",
      "Project Name" : "sso-gcp-dba-ctm4-pub-cc10274",
      "Dataset Name" : "sp500_dataset",
      "Action" : "Load",
      "Run Select Query and Copy to Table" : "unchecked",
      "Copy Operation Type" : "Copy",
      "Destination Table Properties" : "{\"datasetId\": \"sp500_dataset\", \"projectId\": \"sso-gcp-dba-ctm4-pub-cc10274\", \"tableId\": \"sp500_raw\"}",
      "Show Load Options" : "checked",
      "Destination/Source Bucket URIs" : "\"gs://sp500-etl/all_stocks_5yr.csv\"",
      "Load Options" : "\"maxBadRecords\": 10",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "RunAs" : "MOL-BQ-CP",
      "Application" : "zzz_SAP500",
      "Variables" : [ {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-TABLE_ID" : ""
      }, {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-TABLE_ID" : ""
      } ],
      "eventsToWaitFor" : {
        "Type" : "WaitForEvents",
        "Events" : [ {
          "Event" : "BQ_Schema_Table_Creation-TO-BQ_Load_data_to_table"
        } ]
      },
      "eventsToAdd" : {
        "Type" : "AddEvents",
        "Events" : [ {
          "Event" : "BQ_Load_data_to_table-TO-BQ_Clean_Data"
        } ]
      },
      "eventsToDelete" : {
        "Type" : "DeleteEvents",
        "Events" : [ {
          "Event" : "BQ_Schema_Table_Creation-TO-BQ_Load_data_to_table"
        } ]
      }
    },
    "BQ MFT Job s3-to-gcs" : {
      "Type" : "Job:FileTransfer",
      "ConnectionProfileSrc" : "MOL_S3_CP",
      "ConnectionProfileDest" : "MOL_GCS_CP",
      "S3BucketNameSrc" : "gcp-bigquery-source",
      "GCSBucketNameDest" : "sp500-etl",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "RunAs" : "MOL_S3_CP+MOL_GCS_CP",
      "Application" : "zzz_SAP500",
      "Variables" : [ {
        "FTP-LOSTYPE" : "Unix"
      }, {
        "FTP-CONNTYPE1" : "S3"
      }, {
        "FTP-ROSTYPE" : "Unix"
      }, {
        "FTP-CONNTYPE2" : "GCS"
      }, {
        "FTP-CM_VER" : "9.0.00"
      }, {
        "FTP-COMPRESSION11" : "0"
      }, {
        "FTP-COMPRESSION21" : "0"
      }, {
        "FTP-OVERRIDE_WATCH_INTERVAL1" : "0"
      }, {
        "FTP-POSTCMD_ON_FAILURE1" : "0"
      }, {
        "FTP-SYNC_DIR_NO_DEL1" : "0"
      } ],
      "FileTransfers" : [ {
        "TransferType" : "Binary",
        "TransferOption" : "SrcToDest",
        "Src" : "/all_stocks_5yr.csv",
        "Dest" : "/",
        "SRC_PATTERN" : "Wildcard",
        "ABSTIME" : "0",
        "TIMELIMIT" : "0",
        "UNIQUE" : "0",
        "SRCOPT" : "0",
        "IF_EXIST" : "0",
        "DSTOPT" : "0",
        "ContinueOnFailure" : false,
        "DeleteFileOnDestIfFails" : false,
        "FailJobOnDestActionFailure" : false,
        "FailJobOnSourceCommandFailure" : false,
        "FailJobOnDestCommandFailure" : false,
        "RECURSIVE" : "0",
        "EXCLUDE_WILDCARD" : "0",
        "TRIM" : "1",
        "NULLFLDS" : "0",
        "VERNUM" : "0",
        "CASEIFS" : "0",
        "FileWatcherOptions" : {
          "MinDetectedSizeInBytes" : "0",
          "UnitsOfTimeLimit" : "Minutes",
          "SkipToNextFileIfCriteriaNotMatch" : false
        },
        "IncrementalTransfer" : {
          "IncrementalTransferEnabled" : false,
          "MaxModificationAgeForFirstRunEnabled" : false,
          "MaxModificationAgeForFirstRunInHours" : "1"
        },
        "SimultaneousTransfer" : {
          "TransferMultipleFilesSimultaneously" : false
        }
      } ],
      "eventsToAdd" : {
        "Type" : "AddEvents",
        "Events" : [ {
          "Event" : "BQ_MFT_Job_s3-to-gcs-TO-BQ_Schema_Table_Creation"
        } ]
      }
    },
    "BQ Schema Table Creation" : {
      "Type" : "Job:GCP BigQuery",
      "ConnectionProfile" : "MOL-BQ-CP",
      "Action" : "Query",
      "Run Select Query and Copy to Table" : "unchecked",
      "Query Type" : "SQL Query",
      "Copy Operation Type" : "Copy",
      "Show Load Options" : "unchecked",
      "Project Name" : "sso-gcp-dba-ctm4-pub-cc10274",
      "Dataset Name" : "sp500_dataset",
      "SQL Statement" : "CREATE OR REPLACE TABLE `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.sp500_raw` (date DATE, open FLOAT64, high FLOAT64, low FLOAT64, close FLOAT64, volume INT64, Name STRING);",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "Description" : "This table creates or replaces S&P500_raw table to store raw daily stock data for S&P500 companies including prices, volume, date, and ticker name. It serves as the base table for downstream financial analysis.",
      "RunAs" : "MOL-BQ-CP",
      "Application" : "zzz_SAP500",
      "Variables" : [ {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      }, {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      } ],
      "eventsToWaitFor" : {
        "Type" : "WaitForEvents",
        "Events" : [ {
          "Event" : "BQ_MFT_Job_s3-to-gcs-TO-BQ_Schema_Table_Creation"
        } ]
      },
      "eventsToAdd" : {
        "Type" : "AddEvents",
        "Events" : [ {
          "Event" : "BQ_Schema_Table_Creation-TO-BQ_Load_data_to_table"
        } ]
      },
      "eventsToDelete" : {
        "Type" : "DeleteEvents",
        "Events" : [ {
          "Event" : "BQ_MFT_Job_s3-to-gcs-TO-BQ_Schema_Table_Creation"
        } ]
      }
    },
    "eventsToAdd" : {
      "Type" : "AddEvents",
      "Events" : [ {
        "Event" : "zzz-SP500-MFT-to-Table-Setup-TO-zzz-SP500-Refresh-to-Queries"
      } ]
    }
  },
  "zzz-SP500-Refresh-to-Queries" : {
    "Type" : "Folder",
    "ControlmServer" : "IN01",
    "RunAs" : "controlm",
    "SubApplication" : "zzz_SAP500",
    "Application" : "zzz_SAP500",
    "AWS QuickSight Refresh" : {
      "Type" : "Job:AWS QuickSight",
      "ConnectionProfile" : "MOL-QS-CP",
      "AWS Dataset ID" : "d409fb2a-cf47-4820-a24e-d6eca8bbef9b",
      "Refresh Type" : "Full Refresh",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "RunAs" : "MOL-QS-CP",
      "Application" : "zzz_SAP500",
      "eventsToAdd" : {
        "Type" : "AddEvents",
        "Events" : [ {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Daily_Decliners"
        }, {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Daily_Gainers"
        }, {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Most_Volatile"
        } ]
      }
    },
    "BQ Top Daily Decliners" : {
      "Type" : "Job:GCP BigQuery",
      "ConnectionProfile" : "MOL-BQ-CP",
      "Action" : "Query",
      "Run Select Query and Copy to Table" : "unchecked",
      "Query Type" : "SQL Query",
      "Copy Operation Type" : "Copy",
      "Show Load Options" : "unchecked",
      "Project Name" : "sso-gcp-dba-ctm4-pub-cc10274",
      "Dataset Name" : "sp500_dataset",
      "SQL Statement" : "CREATE OR REPLACE TABLE `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.top_daily_decliners` AS SELECT Name, date, ROUND(((close - open) / open) * 100, 2) AS percent_change FROM `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.sp500_clean` WHERE date = '2018-02-07' ORDER BY percent_change ASC LIMIT 10;",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "Description" : "This query identifies the 10 stocks with the largest negative price movements (i.e., biggest losers) based on the percentage drop from open to close on the previous trading day.",
      "RunAs" : "MOL-BQ-CP",
      "Application" : "zzz_SAP500",
      "Variables" : [ {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      }, {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      } ],
      "eventsToWaitFor" : {
        "Type" : "WaitForEvents",
        "Events" : [ {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Daily_Decliners"
        } ]
      },
      "eventsToDelete" : {
        "Type" : "DeleteEvents",
        "Events" : [ {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Daily_Decliners"
        } ]
      }
    },
    "BQ Top Daily Gainers" : {
      "Type" : "Job:GCP BigQuery",
      "ConnectionProfile" : "MOL-BQ-CP",
      "Action" : "Query",
      "Run Select Query and Copy to Table" : "unchecked",
      "Query Type" : "SQL Query",
      "Copy Operation Type" : "Copy",
      "Show Load Options" : "unchecked",
      "Project Name" : "sso-gcp-dba-ctm4-pub-cc10274",
      "Dataset Name" : "sp500_dataset",
      "SQL Statement" : "CREATE OR REPLACE TABLE `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.top_daily_gainers` AS SELECT Name, date, ROUND(((close - open) / open) * 100, 2) AS percent_change FROM `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.sp500_clean` WHERE date = '2018-02-07' ORDER BY percent_change DESC LIMIT 10;",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "Description" : "This query calculates the daily percentage change for each stock (from open to close) and returns the top 10 stocks with the highest gains (largest positive change) from the previous trading day.",
      "RunAs" : "MOL-BQ-CP",
      "Application" : "zzz_SAP500",
      "Variables" : [ {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      }, {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      } ],
      "eventsToWaitFor" : {
        "Type" : "WaitForEvents",
        "Events" : [ {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Daily_Gainers"
        } ]
      },
      "eventsToDelete" : {
        "Type" : "DeleteEvents",
        "Events" : [ {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Daily_Gainers"
        } ]
      }
    },
    "BQ Top Most Volatile" : {
      "Type" : "Job:GCP BigQuery",
      "ConnectionProfile" : "MOL-BQ-CP",
      "Action" : "Query",
      "Run Select Query and Copy to Table" : "unchecked",
      "Query Type" : "SQL Query",
      "Copy Operation Type" : "Copy",
      "Show Load Options" : "unchecked",
      "Project Name" : "sso-gcp-dba-ctm4-pub-cc10274",
      "Dataset Name" : "sp500_dataset",
      "SQL Statement" : "CREATE OR REPLACE TABLE `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.top_daily_volatile` AS SELECT Name, date, ROUND(((high - low) / open) * 100, 2) AS intraday_volatility FROM `sso-gcp-dba-ctm4-pub-cc10274.sp500_dataset.sp500_clean` WHERE date = '2018-02-07' ORDER BY intraday_volatility DESC LIMIT 10;",
      "SubApplication" : "zzz_SAP500",
      "Host" : "ath4_instruqt_server",
      "Description" : "This query calculates the intraday price range (difference between high and low prices) for each stock and lists the top 10 most volatile stocks for the previous trading day.",
      "RunAs" : "MOL-BQ-CP",
      "Application" : "zzz_SAP500",
      "Variables" : [ {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      }, {
        "UCM-SOURCE_TABLES" : ""
      }, {
        "UCM-DESTINATION_TABLE" : ""
      }, {
        "UCM-LOAD_OPTION" : ""
      }, {
        "UCM-BUCKET" : ""
      }, {
        "UCM-TABLE_ID" : ""
      } ],
      "eventsToWaitFor" : {
        "Type" : "WaitForEvents",
        "Events" : [ {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Most_Volatile"
        } ]
      },
      "eventsToDelete" : {
        "Type" : "DeleteEvents",
        "Events" : [ {
          "Event" : "AWS_QuickSight_Refresh-TO-BQ_Top_Most_Volatile"
        } ]
      }
    },
    "eventsToWaitFor" : {
      "Type" : "WaitForEvents",
      "Events" : [ {
        "Event" : "zzz-SP500-MFT-to-Table-Setup-TO-zzz-SP500-Refresh-to-Queries"
      } ]
    },
    "eventsToDelete" : {
      "Type" : "DeleteEvents",
      "Events" : [ {
        "Event" : "zzz-SP500-MFT-to-Table-Setup-TO-zzz-SP500-Refresh-to-Queries"
      } ]
    }
  }
}
