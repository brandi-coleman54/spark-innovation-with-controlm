pipeline {
  agent any

  stages {
    stage('Validate CTM CLI') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            ctm -v
            '''
			}
		}

     stage('Deploy Transform Workflow') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            ctm deploy transform /var/jenkins_home/workflows/forecast-flow-jenkins/workflows/forecast-flow.json /var/jenkins_home/workflows/forecast-flow-jenkins/local_repo/deploy_descriptor_success.json
            '''
			}
		}
    
     stage('Build Workflow') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            BUILD_OUTPUT=$(ctm build \
        	/var/jenkins_home/workflows/forecast-flow-jenkins/workflows/forecast-flow.json \
        	/var/jenkins_home/workflows/forecast-flow-jenkins/local_repo/deploy_descriptor_success.json)

      		echo "$BUILD_OUTPUT"

      		# Fail if warnings exist
      		if echo "$BUILD_OUTPUT" | grep -q '"warnings":'; then
        		echo "❌ Build contains warnings. Failing pipeline."
        		exit 1
      		fi

      		echo "✅ Build validation passed with no warnings."
            '''
			}
		}

    stage('Deploy Workflow') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            ctm deploy /var/jenkins_home/workflows/forecast-flow-jenkins/workflows/forecast-flow.json /var/jenkins_home/workflows/forecast-flow-jenkins/local_repo/deploy_descriptor_success.json
            '''
			}
		}
	}
}
