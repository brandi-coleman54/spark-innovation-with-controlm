pipeline {
  agent any

  stages {
    stage('Validate CTM CLI') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            ctm -v
            '''
			}
		}

     stage('Deploy Transform Workflow') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            ctm deploy transform /var/jenkins_home/workflows/forecast-flow-jenkins/workflows/forecast-flow.json /var/jenkins_home/workflows/forecast-flow-jenkins/local_repo/deploy_descriptor.json
            '''
			}
		}
    
     stage('Build Workflow') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            ctm build /var/jenkins_home/workflows/forecast-flow-jenkins/workflows/forecast-flow.json /var/jenkins_home/workflows/forecast-flow-jenkins/local_repo/deploy_descriptor.json
            '''
			}
		}

    stage('Deploy Workflow') {
      steps {
        sh '''#!/usr/bin/env bash
            set -euo pipefail
            source /var/jenkins_home/venv/bin/activate 
            ctm deploy /var/jenkins_home/workflows/forecast-flow-jenkins/workflows/forecast-flow.json /var/jenkins_home/workflows/forecast-flow-jenkins/local_repo/deploy_descriptor.json
            '''
			}
		}
	}
}
